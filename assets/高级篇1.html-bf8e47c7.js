import{ac as e,F as o,G as c,D as n,R as s,M as t,ad as p,V as l}from"./framework-f12b30cc.js";const u={},i=p('<h1 id="高级篇1" tabindex="-1"><a class="header-anchor" href="#高级篇1" aria-hidden="true">#</a> 高级篇1</h1><h2 id="es常用概念" tabindex="-1"><a class="header-anchor" href="#es常用概念" aria-hidden="true">#</a> ES常用概念</h2><h3 id="索引-类型-文档是什么" tabindex="-1"><a class="header-anchor" href="#索引-类型-文档是什么" aria-hidden="true">#</a> 索引，类型，文档是什么？</h3><ul><li>索引就像是Mysql中的库</li><li>类型就像是Mysql中的表</li><li>文档就像是数据</li><li>属性就是列名</li><li>所有的数据都是Json格式</li></ul><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220827202927609.png" alt="image-20220827202927609" tabindex="0" loading="lazy"><figcaption>image-20220827202927609</figcaption></figure><h3 id="倒排索引" tabindex="-1"><a class="header-anchor" href="#倒排索引" aria-hidden="true">#</a> 倒排索引</h3><blockquote><p>简约理解版本2.0</p></blockquote><p><code>正向索引</code>，数据库创建索引，增加搜索速度。 <code>倒排索引</code>是根据关键字去找文档，然后记录一下出现的位置和次数。</p><p>根据关键字去找文档，然后记录一下出现的位置和次数</p><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220827204624593.png" alt="image-20220827204624593" tabindex="0" loading="lazy"><figcaption>image-20220827204624593</figcaption></figure><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220827204717501.png" alt="image-20220827204717501" tabindex="0" loading="lazy"><figcaption>image-20220827204717501</figcaption></figure><blockquote><p>什么是倒排索引？</p></blockquote>',12),r={href:"https://so.csdn.net/so/search?q=ElasticSearch&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},k=n("code",null,"倒排索引（Inverted Index）也叫反向索引",-1),d=n("code",null,"通过value找key",-1),v=p(`<figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220827204830365.png" alt="image-20220827204830365" tabindex="0" loading="lazy"><figcaption>image-20220827204830365</figcaption></figure><p>首先弄懂几个概念，如果类比现代汉语词典的话，那么<code>Term</code>就相当于<code>词语</code>，<code>Term Dictionary</code>相当于<code>汉语词典本身</code>，<code>Term Index</code>相当于词典的<code>目录索引</code>，<code>Posting List</code>相当于<code>词语在字典的页数集合</code>：</p><ul><li>Term（单词）：一段文本经过分析器分析以后就会输出一串单词，这一个一个的就叫做Term（直译为：单词）</li><li>Term Dictionary（单词字典）：顾名思义，它里面维护的是Term，可以理解为Term的集合</li><li>Term Index（单词索引）：为了更快的找到某个单词，我们为单词建立索引。B-Tree通过减少磁盘寻道次数来提高查询性能，</li><li>Elasticsearch也是采用同样的思路，直接通过内存查找term，不读磁盘，但是如果term太多，term dictionary也会很大，放内存不现实，于是有了Term Index，就像字典里的索引页一样，A开头的有哪些term，分别在哪页，可以理解term index是一颗树：</li><li>Posting List（倒排列表）：倒排列表记录了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息，每条记录称为一个倒排项(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。（PS：实际的倒排列表中并不只是存了文档ID这么简单，还有一些其它的信息，比如：词频（Term出现的次数）、偏移量（offset）等，可以想象成是Python中的元组，或者Java中的对象）</li></ul><h3 id="相关度分数score的计算" tabindex="-1"><a class="header-anchor" href="#相关度分数score的计算" aria-hidden="true">#</a> 相关度分数score的计算</h3><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220827210614711.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ES工作原理还是很复杂的，现阶段我们学会使用即可，到后期准备面试了，在继续深入学习！</p><h2 id="安装es和kibana" tabindex="-1"><a class="header-anchor" href="#安装es和kibana" aria-hidden="true">#</a> 安装ES和Kibana</h2><h3 id="快速安装" tabindex="-1"><a class="header-anchor" href="#快速安装" aria-hidden="true">#</a> 快速安装</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>（1）下载ealastic search（存储和检索）和kibana（可视化检索）
<span class="token function">docker</span> pull elasticsearch:7.4.2
<span class="token function">docker</span> pull kibana:7.4.2

（2）配置
<span class="token comment"># 将docker里的目录挂载到linux的/mydata目录中</span>
<span class="token comment"># 修改/mydata就可以改掉docker里的</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/config
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/data

<span class="token comment"># es可以被远程任何机器访问</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;http.host: 0.0.0.0&quot;</span> <span class="token operator">&gt;</span>/mydata/elasticsearch/config/elasticsearch.yml

<span class="token comment"># 递归更改权限，es需要访问</span>
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> /mydata/elasticsearch/

（3）启动Elastic search
<span class="token comment"># 9200是用户交互端口 9300是集群心跳端口</span>
<span class="token comment"># -e指定是单阶段运行</span>
<span class="token comment"># -e指定占用的内存大小，生产时可以设置32G</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> elasticsearch <span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\\</span>
<span class="token parameter variable">-e</span>  <span class="token string">&quot;discovery.type=single-node&quot;</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xms64m -Xmx512m&quot;</span> <span class="token punctuation">\\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="token punctuation">\\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/data:/usr/share/elasticsearch/data <span class="token punctuation">\\</span>
<span class="token parameter variable">-v</span>  /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\\</span>
<span class="token parameter variable">-d</span> elasticsearch:7.4.2 


<span class="token comment"># 设置开机启动elasticsearch</span>
<span class="token function">docker</span> update elasticsearch <span class="token parameter variable">--restart</span><span class="token operator">=</span>always

（4）启动kibana：
<span class="token comment"># kibana指定了了ES交互端口9200  # 5600位kibana主页端口</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> kibana <span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_HOSTS</span><span class="token operator">=</span>http://192.168.1.8:9200 <span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token parameter variable">-d</span> kibana:7.4.2


<span class="token comment"># 设置开机启动kibana</span>
<span class="token function">docker</span> update kibana  <span class="token parameter variable">--restart</span><span class="token operator">=</span>always
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="es" tabindex="-1"><a class="header-anchor" href="#es" aria-hidden="true">#</a> ES</h3>`,10),m={href:"http://192.168.1.8:9200",target:"_blank",rel:"noopener noreferrer"},b=n("figure",null,[n("img",{src:"https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220828221425885.png",alt:"image-20220828221425885",tabindex:"0",loading:"lazy"}),n("figcaption",null,"image-20220828221425885")],-1),g=n("h3",{id:"kibana",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#kibana","aria-hidden":"true"},"#"),s(" kibana")],-1),q={href:"http://192.168.1.8:5601/app/kibana",target:"_blank",rel:"noopener noreferrer"},y=p(`<figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220828225649670.png" alt="image-20220828225649670" tabindex="0" loading="lazy"><figcaption>image-20220828225649670</figcaption></figure><h2 id="初步检索-cat" tabindex="-1"><a class="header-anchor" href="#初步检索-cat" aria-hidden="true">#</a> 初步检索_cat</h2><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220908221832599.png" alt="image-20220908221832599" tabindex="0" loading="lazy"><figcaption>image-20220908221832599</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /_cat/nodes	
查看所有节点。集群中会用到

GET /_cat/health
查看es健康状况

GET /_cat/master
查看主节点

GET /_cat/indices
查看所有索引 ，等价于mysql数据库的show databases;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="es的增删改查" tabindex="-1"><a class="header-anchor" href="#es的增删改查" aria-hidden="true">#</a> ES的增删改查</h2><h3 id="新增文档" tabindex="-1"><a class="header-anchor" href="#新增文档" aria-hidden="true">#</a> 新增文档</h3><h4 id="put新增" tabindex="-1"><a class="header-anchor" href="#put新增" aria-hidden="true">#</a> put新增</h4><p>新增文档也就是新增数据库中的表，保存的时候用唯一的标识指定</p>`,8),h={href:"http://192.168.1.8:9200/customer/external/1",target:"_blank",rel:"noopener noreferrer"},f=p(`<figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220908222938948.png" alt="image-20220908222938948" tabindex="0" loading="lazy"><figcaption>image-20220908222938948</figcaption></figure><h4 id="post新增" tabindex="-1"><a class="header-anchor" href="#post新增" aria-hidden="true">#</a> post新增</h4><blockquote><p>不带id</p></blockquote><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220908223139707.png" alt="image-20220908223139707" tabindex="0" loading="lazy"><figcaption>image-20220908223139707</figcaption></figure><blockquote><p>带上id，也是新增修改二合一</p></blockquote><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220908223219720.png" alt="image-20220908223219720" tabindex="0" loading="lazy"><figcaption>image-20220908223219720</figcaption></figure><h4 id="区别" tabindex="-1"><a class="header-anchor" href="#区别" aria-hidden="true">#</a> 区别</h4><p><strong>PUT必须指定id</strong>；由于PUT需要指定id，我们一般用来做修改操作</p><p>POST新增。如果<code>不指定id</code>，<strong>会自动生成id</strong>，<code>指定</code>存在的id为<strong>更新</strong></p><h3 id="查询文档" tabindex="-1"><a class="header-anchor" href="#查询文档" aria-hidden="true">#</a> 查询文档</h3><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220908223616528.png" alt="image-20220908223616528" tabindex="0" loading="lazy"><figcaption>image-20220908223616528</figcaption></figure><p>GET /customer/external/1</p><h4 id="乐观锁的使用" tabindex="-1"><a class="header-anchor" href="#乐观锁的使用" aria-hidden="true">#</a> 乐观锁的使用</h4><p>通过“<code>if_seq_no=1&amp;if_primary_term=1</code>”，当序列号匹配的时候，才进行修改，否则不修改。</p><p>开启事务锁后，两个事务并行修改数据的时候，只要有一个事务修改完数据，记录中记录的版本号就会加1，另一个事务修改的时候会带上版本号判断，如果版本号发生了变化了那就不会进行修改</p><h3 id="更新文档-update" tabindex="-1"><a class="header-anchor" href="#更新文档-update" aria-hidden="true">#</a> 更新文档_update</h3><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST customer/externel/<span class="token number">1</span>/_update
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;111&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
或者
POST customer/externel/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;222&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不同：带有update情况下</p><ul><li>POST操作会对比源文档数据，如果相同不会有什么操作，文档version不增加。(带乐观锁)</li><li>PUT操作总会重新保存并增加version版本（不带）</li></ul><h3 id="删除文档或索引" tabindex="-1"><a class="header-anchor" href="#删除文档或索引" aria-hidden="true">#</a> 删除文档或索引</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DELETE customer/external/1
DELETE customer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>注：elasticsearch并没有提供删除类型的操作，只提供了删除索引和文档的操作。</p><h3 id="es的批量操作-bulk" tabindex="-1"><a class="header-anchor" href="#es的批量操作-bulk" aria-hidden="true">#</a> ES的批量操作_bulk</h3><h4 id="执行多条数据" tabindex="-1"><a class="header-anchor" href="#执行多条数据" aria-hidden="true">#</a> 执行多条数据</h4><p><strong>这些数据之间是相互独立的，一条失败，不会影响其他数据</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>kibana中执行
<span class="token constant">POST</span> <span class="token operator">/</span>customer<span class="token operator">/</span>external<span class="token operator">/</span>_bulk
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;John Doe&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;John Doe&quot;</span><span class="token punctuation">}</span>

#<span class="token operator">!</span> <span class="token class-name">Deprecation</span><span class="token operator">:</span> <span class="token punctuation">[</span>types removal<span class="token punctuation">]</span> <span class="token class-name">Specifying</span> types in bulk requests is deprecated<span class="token punctuation">.</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token string">&quot;errors&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;items&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token string">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">200</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token string">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
        <span class="token string">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">201</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="样本测试数据" tabindex="-1"><a class="header-anchor" href="#样本测试数据" aria-hidden="true">#</a> 样本测试数据</h4>`,27),S={href:"https://gitee.com/xlh_blog/common_content/blob/master/es%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json#",target:"_blank",rel:"noopener noreferrer"},_=n("figure",null,[n("img",{src:"https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220916145508913.png",alt:"image-20220916145508913",tabindex:"0",loading:"lazy"}),n("figcaption",null,"image-20220916145508913")],-1),x=n("figure",null,[n("img",{src:"https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220916145647767.png",alt:"image-20220916145647767",tabindex:"0",loading:"lazy"}),n("figcaption",null,"image-20220916145647767")],-1),w=n("h2",{id:"es进阶",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#es进阶","aria-hidden":"true"},"#"),s(" ES进阶")],-1),j={href:"https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docs-reindex.html",target:"_blank",rel:"noopener noreferrer"},E=p(`<p>官方文档如下：</p><p>如下示例看着文档就可以写出来。</p><h3 id="两种查询方式" tabindex="-1"><a class="header-anchor" href="#两种查询方式" aria-hidden="true">#</a> 两种查询方式</h3><p>ES支持两种基本方式检索；</p><ul><li>通过REST request uri 发送搜索参数 （uri +检索参数）；</li><li>通过REST request body 来发送它们（uri+请求体）；</li></ul><p>测试如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search/?q=*&amp;sort=account_number<span class="token operator">:</span>asc

说明： q=* # 查询所有 sort # 排序字段 asc #升序

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


添加新的查询条件
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;balance&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="querydsl" tabindex="-1"><a class="header-anchor" href="#querydsl" aria-hidden="true">#</a> QueryDSL</h3><p>QueryDSL就是我们第二种查询方式中请求体的内容</p><p>它的格式如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>如果针对于某个字段，那么它的结构如下：
<span class="token punctuation">{</span>
  QUERY_NAME<span class="token operator">:</span><span class="token punctuation">{</span>   # 使用的功能
     FIELD_NAME<span class="token operator">:</span><span class="token punctuation">{</span>  #  功能参数
       ARGUMENT<span class="token operator">:</span>VALUE<span class="token punctuation">,</span>
       ARGUMENT<span class="token operator">:</span>VALUE<span class="token punctuation">,</span>...
      <span class="token punctuation">}</span>   
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  #  查询的字段
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  # 从第几条文档开始查
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>	#_source为要返回的字段
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # 返回结果按哪个列排序
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>  # 降序
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="常用查询" tabindex="-1"><a class="header-anchor" href="#常用查询" aria-hidden="true">#</a> 常用查询</h3><h4 id="match全文检索" tabindex="-1"><a class="header-anchor" href="#match全文检索" aria-hidden="true">#</a> match全文检索</h4><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token string">&quot;20&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

#字符串
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kings&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>match_phrase短语匹配</p></blockquote><p>规则如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code># 精准匹配， 不拆分字符串进行检索
# match_phrase：不拆分字符串进行检索
# 字段.keyword：必须全匹配上才检索成功
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_phrase&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill road&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address.keyword&quot;</span><span class="token operator">:</span> <span class="token string">&quot;990 Mill&quot;</span>  
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><h5 id="query-bool-must复合查询" tabindex="-1"><a class="header-anchor" href="#query-bool-must复合查询" aria-hidden="true">#</a> query/bool/must复合查询</h5></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code># must：必须达到must所列举的所有条件
GET bank/_search
<span class="token punctuation">{</span>
   <span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>   
             <span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
              <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;mill&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
             <span class="token punctuation">]</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


# must_not：必须不匹配must_not所列举的所有条件。
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;gender&quot;</span><span class="token operator">:</span> <span class="token string">&quot;M&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;38&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# should：应该达到should列举的条件，如果到达会增加相关文档的评分，并不会改变查询的结果。如果query中只有should且只有一种匹配规则，那么should的条件就会被作为默认匹配条件二区改变查询结果。
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;gender&quot;</span><span class="token operator">:</span> <span class="token string">&quot;M&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;18&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;should&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Wallace&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220916161801449.png" alt="image-20220916161801449" tabindex="0" loading="lazy"><figcaption>image-20220916161801449</figcaption></figure><p>能够看到相关度越高，得分也越高。</p><blockquote><p>query/filter【结果过滤】</p></blockquote><ul><li>must 贡献得分</li><li>should 贡献得分</li><li>must_not 不贡献得分</li><li>filter 不贡献得分</li></ul><p>匹配的越多，得分越高！只有must和should影响相关性得分</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  
        <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;balance&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  
            <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token string">&quot;20000&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


#这条是不会显示结果的，结果都是<span class="token number">0</span>
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;balance&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token string">&quot;20000&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>query/term</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code># 全文检索字段用match，其他非text字段匹配用term。
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill Road&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="aggs-agg1-聚合" tabindex="-1"><a class="header-anchor" href="#aggs-agg1-聚合" aria-hidden="true">#</a> aggs/agg1（聚合）</h4><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code># 聚合查询就是查一点这个，查一点哪个，不是单一的查询
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;ageAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ageAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;balanceAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918101359920.png" alt="image-20220918101359920" tabindex="0" loading="lazy"><figcaption>image-20220918101359920</figcaption></figure><blockquote><p>nested对象聚合</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET articles/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> # 
      <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> #
        <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;payment&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;amount_avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;payment.amount&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="mapping字段映射" tabindex="-1"><a class="header-anchor" href="#mapping字段映射" aria-hidden="true">#</a> Mapping字段映射</h3><blockquote><p>映射定义文档如何被存储和检索的</p></blockquote><p>Mapping映射是用来定义一个文档（document），以及它所包含的属性（field）是如何存储和索引的。比如：使用mapping来定义：</p><p>当然对于已经存在的字段进行映射的时候，我们不能进行更新。更新必须创建新的索引才行</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code># 创建索引的时候去指定

PUT /my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> 
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>更新索引</p></blockquote><p>对于已经存在的字段映射，我们不能更新。更新必须创建新的索引，<strong>进行数据迁移。</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>添加新的字段映射\`PUT /my_index/_mapping\`
PUT /my_index/_mapping
{
  &quot;properties&quot;: {
    &quot;employee-id&quot;: {
      &quot;type&quot;: &quot;keyword&quot;,
      &quot;index&quot;: false # 字段不能被检索。检索
    }
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>数据迁移</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _reindex
<span class="token punctuation">{</span>
  <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;account&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;newbank&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /newbank/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分词" tabindex="-1"><a class="header-anchor" href="#分词" aria-hidden="true">#</a> 分词</h3><p>ES中的分词就是能接收一个字符流，将之分割为独立的token（词元，<strong>通常是独立的单词</strong>），然后输入tokens流</p><p>简单来说，ES解析你的输入，是一个一个字的去读取</p><p>如下：</p><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220916200003529.png" alt="image-20220916200003529" tabindex="0" loading="lazy"><figcaption>image-20220916200003529</figcaption></figure>`,47),M=n("p",null,"使用分词器",-1),I={href:"https://www.elastic.co/guide/en/elasticsearch/reference/7.6/analysis.html",target:"_blank",rel:"noopener noreferrer"},L=n("p",null,"对于中文，我们需要安装额外的分词器",-1),A=n("p",null,"下载地址：",-1),T={href:"https://github.com/medcl/elasticsearch-analysis-ik/releases",target:"_blank",rel:"noopener noreferrer"},R=p(`<p>将上面下载的插件，放到es的plugs文件夹下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost plugins<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/mydata/elasticsearch/plugins/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>重启ES，测试分词器是否安装成功</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET _analyze
<span class="token punctuation">{</span>
   <span class="token property">&quot;text&quot;</span><span class="token operator">:</span><span class="token string">&quot;我是中国人&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果可以解析中文成功，证明安装成功</p><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220916200023982.png" alt="image-20220916200023982" tabindex="0" loading="lazy"><figcaption>image-20220916200023982</figcaption></figure><blockquote><p>调整虚拟机内存为3G</p></blockquote><h4 id="自定义词库" tabindex="-1"><a class="header-anchor" href="#自定义词库" aria-hidden="true">#</a> 自定义词库</h4><p>上面ES虽然能识别中文了，但是也是一个一个字识别的，我们想让它按我们的规矩来的话，我们需要自定义一下</p><p>默认es是不支持一些新的词语，它的词库里组合是很不规律的</p><p>那么我们可以自定义扩展一下这个词库！怎么扩展呢？</p><h4 id="安装nginx" tabindex="-1"><a class="header-anchor" href="#安装nginx" aria-hidden="true">#</a> 安装Nginx</h4><p>将分词内容放到nginx服务器当中</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>随便启动一个Nginx，目的是单纯为了复制配置文件
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx <span class="token parameter variable">-d</span> nginx:1.10

<span class="token function">docker</span> container <span class="token function">cp</span> nginx:/etc/nginx <span class="token builtin class-name">.</span>
<span class="token function">mv</span> nginx/ conf
<span class="token function">mv</span> conf/ /mydata/nginx
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> nginx

结构如下：
<span class="token punctuation">[</span>root@localhost mydata<span class="token punctuation">]</span><span class="token comment"># cd nginx/</span>
<span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># ls</span>
conf
<span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># cd conf/</span>
<span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># ls</span>
conf.d  fastcgi_params  html  koi-utf  koi-win  logs  mime.types  modules  nginx.conf  scgi_params  uwsgi_params  win-utf

<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx <span class="token punctuation">\\</span>
<span class="token parameter variable">-v</span> /mydata/nginx/html:/usr/share/nginx/html <span class="token punctuation">\\</span>
<span class="token parameter variable">-v</span> /mydata/nginx/logs:/var/log/nginx <span class="token punctuation">\\</span>
<span class="token parameter variable">-v</span> /mydata/nginx/conf:/etc/nginx <span class="token punctuation">\\</span>
<span class="token parameter variable">-d</span> nginx:1.10

<span class="token function">mkdir</span> /mydata/nginx/html/es
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /mydata/nginx/html/es/fenci.txt </span>
彭于晏
杜兰特
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>修改ESIKAnalyzer.cfg.xml</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost config<span class="token punctuation">]</span><span class="token comment"># cat IKAnalyzer.cfg.xml </span>
CTYPE properties SYSTEM <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>properties<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>comment<span class="token operator">&gt;</span>IK Analyzer 扩展配置<span class="token operator">&lt;</span>/comment<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置自己的扩展字典 --<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;ext_dict&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span>
	 <span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置自己的扩展停止词字典--<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;ext_stopwords&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置远程扩展字典 --<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;remote_ext_dict&quot;</span><span class="token operator">&gt;</span>http://192.168.1.8/es/fenci.txt<span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span> 
	<span class="token operator">&lt;</span><span class="token operator">!</span>--用户可以在这里配置远程扩展停止词字典--<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span>-- <span class="token operator">&lt;</span>entry <span class="token assign-left variable">key</span><span class="token operator">=</span><span class="token string">&quot;remote_ext_stopwords&quot;</span><span class="token operator">&gt;</span>words_location<span class="token operator">&lt;</span>/entry<span class="token operator">&gt;</span> --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/properties<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改完成后，需要重启es容器，否则修改不生效。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>docker restart elasticsearch

POST _analyze
<span class="token punctuation">{</span>
   <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span> 
   <span class="token property">&quot;text&quot;</span><span class="token operator">:</span><span class="token string">&quot;我是彭于晏&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220916214544277.png" alt="image-20220916214544277" tabindex="0" loading="lazy"><figcaption>image-20220916214544277</figcaption></figure><p>当然后面有新词的话，那就直接在es指定目录下继续添加新词即可</p><h2 id="整合elasticsearch" tabindex="-1"><a class="header-anchor" href="#整合elasticsearch" aria-hidden="true">#</a> 整合ElasticSearch</h2><p>我们先来一个简单的写写试试</p>`,22),B={href:"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html",target:"_blank",rel:"noopener noreferrer"},O=p(`<h3 id="配置类" tabindex="-1"><a class="header-anchor" href="#配置类" aria-hidden="true">#</a> 配置类</h3><p>固定写法，其中builder = RestClient.builder(new HttpHost(&quot;192.168.1.8&quot;, 9200, &quot;http&quot;));如果有ES集群的话可以用来指定多个ES主机地址</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RequestOptions</span> <span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">RequestOptions<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token constant">COMMON_OPTIONS</span> <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

     <span class="token doc-comment comment">/**
     * 主要是给容器中注入一个RestHighLevelClient
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">esRestClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">RestClientBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 可以指定多个es</span>
        builder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.1.8&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="测试类" tabindex="-1"><a class="header-anchor" href="#测试类" aria-hidden="true">#</a> 测试类</h3><h4 id="保存数据" tabindex="-1"><a class="header-anchor" href="#保存数据" aria-hidden="true">#</a> 保存数据</h4><blockquote><p>测试的时候要在启动类上排除数据库</p><p>@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})</p></blockquote><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918090503391.png" alt="image-20220918090503391" tabindex="0" loading="lazy"><figcaption>image-20220918090503391</figcaption></figure><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918091138369.png" alt="image-20220918091138369" tabindex="0" loading="lazy"><figcaption>image-20220918091138369</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">MallSearchApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">indexData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 设置索引</span>
        <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span> <span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置要保存的内容，指定数据和类型</span>
        indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//执行创建索引和保存数据</span>
        <span class="token class-name">IndexResponse</span> index <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">EsConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220917214616487.png" alt="image-20220917214616487" tabindex="0" loading="lazy"><figcaption>image-20220917214616487</figcaption></figure><h4 id="简单的检索" tabindex="-1"><a class="header-anchor" href="#简单的检索" aria-hidden="true">#</a> 简单的检索</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1 创建检索请求</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchSourceBuilder</span> sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;mill&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        可以加多个检索条件</span>
    <span class="token comment">//        sourceBuilder.query(QueryBuilders.matchQuery(&quot;address&quot;,&quot;mill&quot;));</span>
    <span class="token comment">//        sourceBuilder.query(QueryBuilders.matchQuery(&quot;address&quot;,&quot;mill&quot;));</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2 执行检索</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">EsConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3 分析响应结果</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;mill&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;took&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;timed_out&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;total&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;successful&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;skipped&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;failed&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;hits&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;total&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">&quot;relation&quot;</span><span class="token operator">:</span><span class="token string">&quot;eq&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;max_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token property">&quot;hits&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;970&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token property">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">970</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">19648</span><span class="token punctuation">,</span><span class="token property">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Forbes&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Wallace&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;990 Mill Road&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Pheast&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;forbeswallace@pheast.com&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Lopezo&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;AK&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;136&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token property">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">136</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">45801</span><span class="token punctuation">,</span><span class="token property">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Winnie&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Holland&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;198 Mill Lane&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Neteria&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;winnieholland@neteria.com&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Urie&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;IL&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;345&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token property">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">345</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">9812</span><span class="token punctuation">,</span><span class="token property">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Parker&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Hines&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;715 Mill Avenue&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Baluba&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;parkerhines@baluba.com&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Blackgum&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;KY&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;472&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token property">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">472</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">25571</span><span class="token punctuation">,</span><span class="token property">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Lee&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Long&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;288 Mill Street&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Comverges&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;leelong@comverges.com&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Movico&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;MT&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="复杂的查询" tabindex="-1"><a class="header-anchor" href="#复杂的查询" aria-hidden="true">#</a> 复杂的查询</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 复杂检索:在bank中搜索address中包含mill的所有人的年龄分布以及平均年龄，平均薪资
     *
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">searchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 创建检索请求</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1.1）指定索引</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.2）构造检索条件</span>
    <span class="token class-name">SearchSourceBuilder</span> sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mill&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//1.2.1)按照年龄分布进行聚合</span>
    <span class="token class-name">TermsAggregationBuilder</span> ageAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>ageAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1.2.2)计算平均年龄</span>
    <span class="token class-name">AvgAggregationBuilder</span> ageAvg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;ageAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>ageAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.2.3)计算平均薪资</span>
    <span class="token class-name">AvgAggregationBuilder</span> balanceAvg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>balanceAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;检索条件：&quot;</span> <span class="token operator">+</span> sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 执行检索</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;检索结果：&quot;</span> <span class="token operator">+</span> searchResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//3. 将检索结果封装为Bean</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//4. 获取聚合信息</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Terms</span> ageAgg1 <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> ageAgg1<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> keyAsString <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;年龄：&quot;</span> <span class="token operator">+</span> keyAsString <span class="token operator">+</span> <span class="token string">&quot; ==&gt; &quot;</span> <span class="token operator">+</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Avg</span> ageAvg1 <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ageAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;平均年龄：&quot;</span> <span class="token operator">+</span> ageAvg1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Avg</span> balanceAvg1 <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;平均薪资：&quot;</span> <span class="token operator">+</span> balanceAvg1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行结果如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>检索条件：<span class="token punctuation">{</span><span class="token string">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;Mill&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token string">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token string">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;ageAgg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token string">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;ageAvg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;avg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;avg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
检索结果：<span class="token punctuation">{</span><span class="token string">&quot;took&quot;</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">&quot;timed_out&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token string">&quot;_shards&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;total&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;successful&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;skipped&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;failed&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;hits&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;total&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;relation&quot;</span><span class="token operator">:</span><span class="token string">&quot;eq&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;max_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token string">&quot;hits&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;970&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token string">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">970</span><span class="token punctuation">,</span><span class="token string">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">19648</span><span class="token punctuation">,</span><span class="token string">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Forbes&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Wallace&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token string">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;990 Mill Road&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Pheast&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;forbeswallace@pheast.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Lopezo&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;AK&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;136&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token string">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">136</span><span class="token punctuation">,</span><span class="token string">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">45801</span><span class="token punctuation">,</span><span class="token string">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Winnie&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Holland&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token string">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;198 Mill Lane&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Neteria&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;winnieholland@neteria.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Urie&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;IL&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;345&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token string">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">345</span><span class="token punctuation">,</span><span class="token string">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">9812</span><span class="token punctuation">,</span><span class="token string">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Parker&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Hines&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token string">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;715 Mill Avenue&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Baluba&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;parkerhines@baluba.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Blackgum&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;KY&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;_index&quot;</span><span class="token operator">:</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_type&quot;</span><span class="token operator">:</span><span class="token string">&quot;account&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;472&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;_score&quot;</span><span class="token operator">:</span><span class="token number">5.4032025</span><span class="token punctuation">,</span><span class="token string">&quot;_source&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">472</span><span class="token punctuation">,</span><span class="token string">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">25571</span><span class="token punctuation">,</span><span class="token string">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Lee&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Long&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token string">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;288 Mill Street&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Comverges&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;leelong@comverges.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Movico&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;MT&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;lterms#ageAgg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;doc_count_error_upper_bound&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;sum_other_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;buckets&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;key&quot;</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token string">&quot;doc_count&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;key&quot;</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token string">&quot;doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;key&quot;</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token string">&quot;doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;avg#ageAvg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">34.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;avg#balanceAvg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">25208.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token class-name">MallSearchApplicationTests<span class="token punctuation">.</span>Account</span><span class="token punctuation">(</span>account_number<span class="token operator">=</span><span class="token number">970</span><span class="token punctuation">,</span> balance<span class="token operator">=</span><span class="token number">19648</span><span class="token punctuation">,</span> firstname<span class="token operator">=</span><span class="token class-name">Forbes</span><span class="token punctuation">,</span> lastname<span class="token operator">=</span><span class="token class-name">Wallace</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token class-name">M</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token number">990</span> <span class="token class-name">Mill</span> <span class="token class-name">Road</span><span class="token punctuation">,</span> employer<span class="token operator">=</span><span class="token class-name">Pheast</span><span class="token punctuation">,</span> email<span class="token operator">=</span>forbeswallace<span class="token annotation punctuation">@pheast.com</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token class-name">Lopezo</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token constant">AK</span><span class="token punctuation">)</span>
<span class="token class-name">MallSearchApplicationTests<span class="token punctuation">.</span>Account</span><span class="token punctuation">(</span>account_number<span class="token operator">=</span><span class="token number">136</span><span class="token punctuation">,</span> balance<span class="token operator">=</span><span class="token number">45801</span><span class="token punctuation">,</span> firstname<span class="token operator">=</span><span class="token class-name">Winnie</span><span class="token punctuation">,</span> lastname<span class="token operator">=</span><span class="token class-name">Holland</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token class-name">M</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token number">198</span> <span class="token class-name">Mill</span> <span class="token class-name">Lane</span><span class="token punctuation">,</span> employer<span class="token operator">=</span><span class="token class-name">Neteria</span><span class="token punctuation">,</span> email<span class="token operator">=</span>winnieholland<span class="token annotation punctuation">@neteria.com</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token class-name">Urie</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token constant">IL</span><span class="token punctuation">)</span>
<span class="token class-name">MallSearchApplicationTests<span class="token punctuation">.</span>Account</span><span class="token punctuation">(</span>account_number<span class="token operator">=</span><span class="token number">345</span><span class="token punctuation">,</span> balance<span class="token operator">=</span><span class="token number">9812</span><span class="token punctuation">,</span> firstname<span class="token operator">=</span><span class="token class-name">Parker</span><span class="token punctuation">,</span> lastname<span class="token operator">=</span><span class="token class-name">Hines</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token class-name">M</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token number">715</span> <span class="token class-name">Mill</span> <span class="token class-name">Avenue</span><span class="token punctuation">,</span> employer<span class="token operator">=</span><span class="token class-name">Baluba</span><span class="token punctuation">,</span> email<span class="token operator">=</span>parkerhines<span class="token annotation punctuation">@baluba.com</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token class-name">Blackgum</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token constant">KY</span><span class="token punctuation">)</span>
<span class="token class-name">MallSearchApplicationTests<span class="token punctuation">.</span>Account</span><span class="token punctuation">(</span>account_number<span class="token operator">=</span><span class="token number">472</span><span class="token punctuation">,</span> balance<span class="token operator">=</span><span class="token number">25571</span><span class="token punctuation">,</span> firstname<span class="token operator">=</span><span class="token class-name">Lee</span><span class="token punctuation">,</span> lastname<span class="token operator">=</span><span class="token class-name">Long</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token class-name">F</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token number">288</span> <span class="token class-name">Mill</span> <span class="token class-name">Street</span><span class="token punctuation">,</span> employer<span class="token operator">=</span><span class="token class-name">Comverges</span><span class="token punctuation">,</span> email<span class="token operator">=</span>leelong<span class="token annotation punctuation">@comverges.com</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token class-name">Movico</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token constant">MT</span><span class="token punctuation">)</span>
年龄：<span class="token number">38</span> <span class="token operator">==</span><span class="token operator">&gt;</span> <span class="token number">2</span>
年龄：<span class="token number">28</span> <span class="token operator">==</span><span class="token operator">&gt;</span> <span class="token number">1</span>
年龄：<span class="token number">32</span> <span class="token operator">==</span><span class="token operator">&gt;</span> <span class="token number">1</span>
平均年龄：<span class="token number">34.0</span>
平均薪资：<span class="token number">25208.0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>和我们Kibana显示的结果也对应上了</p><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918101359920.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="二、整合商品上架" tabindex="-1"><a class="header-anchor" href="#二、整合商品上架" aria-hidden="true">#</a> 二、整合商品上架</h1><p>需求：</p><ul><li>在后台选择上架的商品才能在网站展示</li><li>上架的商品也可以被ES检索</li></ul><h2 id="sku在es中存储" tabindex="-1"><a class="header-anchor" href="#sku在es中存储" aria-hidden="true">#</a> sku在es中存储</h2><p>商品上架在es中应该是存储spu</p><ul><li>检索的时候输入名字，这样就是需要用sku的title去全文检索</li><li>检索使用商品规格，规格是spu的公共属性，每个spu是一样的</li></ul><p>方案1：</p><p>缺点：如果每个sku都存储规格参数(如尺寸)，会有冗余存储，因为<strong>每个spu对应的sku的规格参数都一样</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    skuId<span class="token operator">:</span><span class="token number">1</span>
    spuId<span class="token operator">:</span><span class="token number">11</span>
    skyTitile<span class="token operator">:</span>华为xx
    price<span class="token operator">:</span><span class="token number">999</span>
    saleCount<span class="token operator">:</span><span class="token number">99</span>
    attr<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>尺寸<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>CPU<span class="token operator">:</span>高通<span class="token number">945</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>分辨率<span class="token operator">:</span>全高清<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方案2：</p><p>先找到4000个符合要求的spu，再根据4000个spu查询对应的属性，封装了4000个id，long 8B*4000=32000B=32KB 1K个人检索，就是32MB</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>sku索引
<span class="token punctuation">{</span>
    spuId<span class="token operator">:</span><span class="token number">1</span>
    skuId<span class="token operator">:</span><span class="token number">11</span>
<span class="token punctuation">}</span>
attr索引
<span class="token punctuation">{</span>
    skuId<span class="token operator">:</span><span class="token number">11</span>
    attr<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>尺寸<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>CPU<span class="token operator">:</span>高通<span class="token number">945</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>分辨率<span class="token operator">:</span>全高清<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结论：<strong>如果将规格参数单独建立索引，会出现检索时出现大量数据传输的问题，会引起网络网络</strong></p><p>所以我们选方案一，用空间换时间</p><h3 id="最终选用的数据模型" tabindex="-1"><a class="header-anchor" href="#最终选用的数据模型" aria-hidden="true">#</a> 最终选用的数据模型</h3><p>{ “type”: “keyword” }, 保持数据精度问题，可以检索，但不分词 “analyzer”: “ik_smart” 中文分词器 “index”: false, 不可被检索，不生成index “doc_values”: false 默认为true，不可被聚合，es就不会维护一些聚合的信息</p><p><strong>这个数据模型要先在es中建立</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT product
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  
            <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>  
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  
            <span class="token property">&quot;skuImg&quot;</span>  <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  
            <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
            <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  
                <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> 
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
            <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918154851294.png" alt="image-20220918154851294" tabindex="0" loading="lazy"><figcaption>image-20220918154851294</figcaption></figure><h2 id="构造基本数据" tabindex="-1"><a class="header-anchor" href="#构造基本数据" aria-hidden="true">#</a> 构造基本数据</h2><p>商品上架需要在es中保存spu信息并更新spu状态信息，所以我们就建立专门的vo来接收</p><blockquote><p>SkuEsModel</p><p>写在common模块</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkuEsModel</span> <span class="token punctuation">{</span> <span class="token comment">//common中</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> skuTitle<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> skuPrice<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> skuImg<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> saleCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> hasStock<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> hotScore<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brandName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brandImg<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> catalogName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Attr</span><span class="token punctuation">&gt;</span></span> attrs<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Attr</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> attrName<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> attrValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="库存量查询" tabindex="-1"><a class="header-anchor" href="#库存量查询" aria-hidden="true">#</a> 库存量查询</h2><p>上架的话需要确定库存，所以调用ware微服务来检测是否有库存</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;ware/waresku&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WareSkuController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WareSkuService</span> wareSkuService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/hasStock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> vos <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>impl</p></blockquote><p>实现也比较好理解，就是先用自定义的mapper查有没有库存</p><p>有的话，给库存赋值，并收集成集合</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> skuHasStockVos <span class="token operator">=</span> skuIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">getSkuStock</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SkuHasStockVo</span> skuHasStockVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuHasStockVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuHasStockVo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuHasStockVo<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuHasStockVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> skuHasStockVos<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>自定义mapper</p></blockquote><p>这里的库存并不是简单查一下库存表，所以不能用mp自带的api去查询，需要自定义一个简单的sql</p><p>就是用库存减去锁定的库存即可得出！</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;getSkuStock&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;java.lang.Long&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>stock <span class="token operator">-</span> stock_locked<span class="token punctuation">)</span> <span class="token keyword">FROM</span> wms_ware_sku <span class="token keyword">WHERE</span> sku_id <span class="token operator">=</span> <span class="token comment">#{skuId}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="商品上架" tabindex="-1"><a class="header-anchor" href="#商品上架" aria-hidden="true">#</a> 商品上架</h2><h3 id="完整代码" tabindex="-1"><a class="header-anchor" href="#完整代码" aria-hidden="true">#</a> 完整代码</h3><blockquote><p>controller</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 商品上架
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{spuId}/up&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">spuUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    spuInfoService<span class="token punctuation">.</span><span class="token function">up</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>impl</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.获得spu对应的sku集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> skuInfoEntities <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.获得spu的基础属性实体集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductAttrValueEntity</span><span class="token punctuation">&gt;</span></span> baseAttrs <span class="token operator">=</span> productAttrValueService<span class="token punctuation">.</span><span class="token function">baseAttrListforSpu</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.获得基本属性中可搜索的属性id</span>
        <span class="token comment">//3.1获得spu基础属性实体集合中的属性id集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds <span class="token operator">=</span> baseAttrs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> attr<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.2获得可搜索属性实体类对象</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> searchAttrIds <span class="token operator">=</span> attrService<span class="token punctuation">.</span><span class="token function">selectSearchAttrs</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.3将它们转化为set集合</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idSet <span class="token operator">=</span> searchAttrIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.4对所有基础属性实体过滤，第一步是只保留可搜索属性实体类对象，第二步是给这些对象中的Attrs对象赋值，最后收集为attrsList</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">&gt;</span></span> attrsList <span class="token operator">=</span> baseAttrs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> idSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> attrs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//收集所有skuId的集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIdList <span class="token operator">=</span> skuInfoEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SkuInfoEntity</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 1、发送远程调用，库存系统查询是否有库存</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> stockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">R</span> skuHasStock <span class="token operator">=</span> wareFeignService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            stockMap <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>typeReference<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockVo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;库存服务查询异常：原因{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//2、封装每个sku的信息</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> finalStockMap <span class="token operator">=</span> stockMap<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuInfoEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>sku <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//组装需要的数据</span>
            <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setSkuPrice</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setSkuImg</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuDefaultImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//设置库存信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finalStockMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>finalStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//TODO 2、热度评分。0</span>
            esModel<span class="token punctuation">.</span><span class="token function">setHotScore</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//TODO 3、查询品牌和分类的名字信息</span>
            <span class="token class-name">BrandEntity</span> brandEntity <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setBrandId</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">CategoryEntity</span> categoryEntity <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setCatalogId</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            esModel<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//设置检索属性</span>
            esModel<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrsList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>sku<span class="token punctuation">,</span>esModel<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> esModel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 5、将数据发给es进行保存：mall-search</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> searchFeignService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//远程调用成功</span>
            <span class="token comment">//TODO 6、修改当前spu的状态</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">updaSpuStatus</span><span class="token punctuation">(</span>spuId<span class="token punctuation">,</span> <span class="token class-name">ProductConstant<span class="token punctuation">.</span>ProductStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SPU_UP</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//远程调用失败</span>
            <span class="token comment">//TODO 7、重复调用？接口幂等性:重试机制</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="详解" tabindex="-1"><a class="header-anchor" href="#详解" aria-hidden="true">#</a> 详解</h3><h4 id="获得spu对应的sku集合" tabindex="-1"><a class="header-anchor" href="#获得spu对应的sku集合" aria-hidden="true">#</a> 获得spu对应的sku集合</h4><p>其中<code>skuInfoService.getSkusBySpuId</code>中<code>getSkusBySpuId</code>就是写一个简单的query因为是单表查询</p><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918111736538.png" alt="image-20220918111736538" tabindex="0" loading="lazy"><figcaption>image-20220918111736538</figcaption></figure><p>所以应该这样写</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;spu_id&quot;</span><span class="token punctuation">,</span>spuId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="获得spu的基础属性实体集合" tabindex="-1"><a class="header-anchor" href="#获得spu的基础属性实体集合" aria-hidden="true">#</a> 获得spu的基础属性实体集合</h4><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918112625377.png" alt="image-20220918112625377" tabindex="0" loading="lazy"><figcaption>image-20220918112625377</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductAttrValueEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">baseAttrListforSpu</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductAttrValueEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;spu_id&quot;</span><span class="token punctuation">,</span>spuId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="给skuesmodel-attrs对象赋值" tabindex="-1"><a class="header-anchor" href="#给skuesmodel-attrs对象赋值" aria-hidden="true">#</a> 给SkuEsModel.Attrs对象赋值</h4><blockquote><p>找出所有属性的id集合</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds <span class="token operator">=</span> baseAttrs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> attr<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在上面的结果中进行筛选,得到可搜索ID</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> searchAttrIds <span class="token operator">=</span> attrService<span class="token punctuation">.</span><span class="token function">selectSearchAttrs</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中attrService.selectSearchAttrs实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectSearchAttrs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> searchAttrIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> searchAttrIds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的<code>baseMapper.selectSearchAttrIds</code>，baseMapper是MP提供的类，里面很多常见的CRUD，如果要扩展的话，可以直接写扩展的方法名，让写对应的Mapper就行，很方便，安装插件就可以一键生成！</p><p>筛选每个属性，下面sql的意思就是普通的查询加上可搜索id的条件</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;selectSearchAttrIds&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;java.lang.Long&quot;</span><span class="token operator">&gt;</span>
    select <span class="token operator">*</span> from pms_attr where attr_id <span class="token constant">IN</span>
        <span class="token operator">&lt;</span>foreach collection<span class="token operator">=</span><span class="token string">&quot;attrIds&quot;</span> item<span class="token operator">=</span><span class="token string">&quot;id&quot;</span> separator<span class="token operator">=</span><span class="token string">&quot;,&quot;</span> <span class="token keyword">open</span><span class="token operator">=</span><span class="token string">&quot;(&quot;</span> close<span class="token operator">=</span><span class="token string">&quot;)&quot;</span><span class="token operator">&gt;</span>
            #<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>foreach<span class="token operator">&gt;</span>
    <span class="token class-name">AND</span> search_type <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>给SkuEsModel.Attrs对象赋值</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idSet <span class="token operator">=</span> searchAttrIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//3.4对所有基础属性实体过滤，第一步是只保留可搜索属性实体类对象，第二步是给这些对象中的Attrs对象赋值，最后收集为attrsList</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">&gt;</span></span> attrsList <span class="token operator">=</span> baseAttrs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> idSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> attrs<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="查询是否有库存" tabindex="-1"><a class="header-anchor" href="#查询是否有库存" aria-hidden="true">#</a> 查询是否有库存</h4><p>这里属于跨微服务的调用，所以这里使用了openfeign去远程调用ware微服务去查询是否有库存</p><p><code>ware微服务</code>里的<code>查询库存</code>方法为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;ware/waresku&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WareSkuController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">WareSkuService</span> wareSkuService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/hasStock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//skuId stock</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> vos <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ok <span class="token operator">=</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ok<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ok<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>实现如下：</p></blockquote><p>通过skuid来查询该sku的库存数</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> skuHasStockVos <span class="token operator">=</span> skuIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">getSkuStock</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SkuHasStockVo</span> skuHasStockVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuHasStockVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuHasStockVo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuHasStockVo<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuHasStockVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> skuHasStockVos<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>getSkuStock属于自定义的查询接口，内容如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;getSkuStock&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;java.lang.Long&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>stock <span class="token operator">-</span> stock_locked<span class="token punctuation">)</span> <span class="token keyword">FROM</span> wms_ware_sku <span class="token keyword">WHERE</span> sku_id <span class="token operator">=</span> <span class="token comment">#{skuId}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么接下来<code>product微服务</code>就可以使用该方法进行查询了，内容如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> stockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> skuHasStock <span class="token operator">=</span> wareFeignService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    stockMap <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>typeReference<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockVo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;库存服务查询异常：原因{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>对所有sku进行封装</p></blockquote><p><strong>就是对要保存的sku封装成功ES的VO模型进行接收</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> finalStockMap <span class="token operator">=</span> stockMap<span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuInfoEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>sku <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//组装需要的数据</span>
    <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setSkuPrice</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setSkuImg</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuDefaultImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置库存信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finalStockMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>finalStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//TODO 2、热度评分。0</span>
    esModel<span class="token punctuation">.</span><span class="token function">setHotScore</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//TODO 3、查询品牌和分类的名字信息</span>
    <span class="token class-name">BrandEntity</span> brandEntity <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setBrandId</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CategoryEntity</span> categoryEntity <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setCatalogId</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModel<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置检索属性</span>
    esModel<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrsList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>sku<span class="token punctuation">,</span>esModel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> esModel<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="mall-search保存数据" tabindex="-1"><a class="header-anchor" href="#mall-search保存数据" aria-hidden="true">#</a> mall-search保存数据</h4><blockquote><p>controller</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> status <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        status <span class="token operator">=</span> productSaveService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;商品上架错误{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BizCodeEnum</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>impl</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token comment">//1.在es中建立索引</span>

    <span class="token comment">//2. 在ES中保存这些数据</span>
    <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">:</span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//构造保存请求</span>
        <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_INDEX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//        BulkRequest bulkRequest, RequestOptions options</span>
    <span class="token class-name">BulkResponse</span> bulk <span class="token operator">=</span> esRestClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">EsConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//TODO 如果批量错误</span>
    <span class="token keyword">boolean</span> hasFailures <span class="token operator">=</span> bulk<span class="token punctuation">.</span><span class="token function">hasFailures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>bulk<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;商品上架完成：{}&quot;</span><span class="token punctuation">,</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> hasFailures<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="将数据发送给es保存" tabindex="-1"><a class="header-anchor" href="#将数据发送给es保存" aria-hidden="true">#</a> 将数据发送给ES保存</h4><ul><li>FeignService</li><li>通过FeignService远程调用</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;mall-search&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/search/save/product&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//TODO 5、将数据发给es进行保存：mall-search</span>
<span class="token class-name">R</span> r <span class="token operator">=</span> searchFeignService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//远程调用成功</span>
    <span class="token comment">//TODO 6、修改当前spu的状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">updaSpuStatus</span><span class="token punctuation">(</span>spuId<span class="token punctuation">,</span> <span class="token class-name">ProductConstant<span class="token punctuation">.</span>ProductStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SPU_UP</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//远程调用失败</span>
    <span class="token comment">//TODO 7、重复调用？接口幂等性:重试机制</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="debug调式" tabindex="-1"><a class="header-anchor" href="#debug调式" aria-hidden="true">#</a> DeBug调式</h3><p>商品上架用到了三个微服务，分别是product、ware、search</p><p>那我们分别debug启动它们，然后在这些微服务中使用的方法中打上断点，查看调用流程</p><h4 id="获得spu对应的sku集合-1" tabindex="-1"><a class="header-anchor" href="#获得spu对应的sku集合-1" aria-hidden="true">#</a> 获得spu对应的sku集合</h4><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918160846814.png" alt="image-20220918160846814" tabindex="0" loading="lazy"><figcaption>image-20220918160846814</figcaption></figure><h4 id="获得spu的基础属性实体集合-1" tabindex="-1"><a class="header-anchor" href="#获得spu的基础属性实体集合-1" aria-hidden="true">#</a> 获得spu的基础属性实体集合</h4><blockquote><p>基础属性如下：</p></blockquote><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918161228025.png" alt="image-20220918161228025" tabindex="0" loading="lazy"><figcaption>image-20220918161228025</figcaption></figure><h4 id="给skuesmodel-attrs对象赋值-1" tabindex="-1"><a class="header-anchor" href="#给skuesmodel-attrs对象赋值-1" aria-hidden="true">#</a> 给SkuEsModel.Attrs对象赋值</h4><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918190006951.png" alt="image-20220918190006951" tabindex="0" loading="lazy"><figcaption>image-20220918190006951</figcaption></figure><p>测试</p><figure><img src="https://typora-1259403628.cos.ap-nanjing.myqcloud.com/image-20220918192444697.png" alt="image-20220918192444697" tabindex="0" loading="lazy"><figcaption>image-20220918192444697</figcaption></figure>`,115);function C(H,P){const a=l("ExternalLinkIcon");return o(),c("div",null,[i,n("p",null,[n("a",r,[s("ElasticSearch"),t(a)]),s("中一个重要的概念 ： "),k,s("，有反向索引必有正向索引。通俗地来讲，正向索引是通过key找value，反向索引则是"),d,s("。")]),v,n("p",null,[s("查看elasticsearch版本信息： "),n("a",m,[s("http://192.168.1.8:9200"),t(a)])]),b,g,n("p",null,[s("访问Kibana： "),n("a",q,[s("http://192.168.1.8:5601/app/kibana"),t(a)])]),y,n("p",null,[n("a",h,[s("http://192.168.1.8:9200/customer/external/1"),t(a)])]),f,n("p",null,[n("a",S,[s("https://gitee.com/xlh_blog/common_content/blob/master/es测试数据.json#"),t(a)])]),_,x,w,n("p",null,[n("a",j,[s("https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docs-reindex.html"),t(a)])]),E,n("blockquote",null,[M,n("p",null,[s("关于分词器： "),n("a",I,[s("https://www.elastic.co/guide/en/elasticsearch/reference/7.6/analysis.html"),t(a)])])]),L,A,n("p",null,[n("a",T,[s("https://github.com/medcl/elasticsearch-analysis-ik/releases"),t(a)])]),R,n("p",null,[s("官方文档如下： "),n("a",B,[s("https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html"),t(a)])]),O])}const N=e(u,[["render",C],["__file","高级篇1.html.vue"]]);export{N as default};
